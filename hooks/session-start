#!/usr/bin/env bash
# session-start: Track session and terminal agent start
set -euo pipefail

read -r -t 5 -d '' INPUT || true
[[ -z "$INPUT" ]] && exit 0
SESSION_ID=$(printf '%s' "$INPUT" | jq -r '.session_id // ""' 2>/dev/null)
# Sanitize: only safe characters (used in file paths)
[[ ! "$SESSION_ID" =~ ^[a-zA-Z0-9_-]+$ ]] && SESSION_ID=""
AGENT_STATS="$HOME/.claude/agent-stats.csv"
SESSION_BUDGET_DIR="$HOME/.claude/.session-budgets"

if [ -n "$SESSION_ID" ]; then
  mkdir -p "$HOME/.claude/.session-times"
  mkdir -p "$SESSION_BUDGET_DIR"
  date +%s > "$HOME/.claude/.session-times/$SESSION_ID.start"
  # Warden TUI: record session start for relative timestamps
  mkdir -p "$HOME/.claude/.statusline"
  date +%s.%N > "$HOME/.claude/.statusline/.session_start"

  # Snapshot budget at session start (if budget-cli is installed)
  if command -v budget-cli &>/dev/null; then
    budget-cli export > "$SESSION_BUDGET_DIR/$SESSION_ID.start.json" 2>/dev/null || true
    # Refresh Prometheus textfile metrics
    BUDGET_EXPORTER="$HOME/dev/claude-code-monitoring-guide/budget-exporter.sh"
    [[ -x "$BUDGET_EXPORTER" ]] && "$BUDGET_EXPORTER" 2>/dev/null &
  fi

  # Initialize unified agent stats CSV with header if needed
  if [ ! -f "$AGENT_STATS" ]; then
    echo "timestamp,agent_id,agent_category,agent_type,duration_seconds,session_id,status" > "$AGENT_STATS"
  fi

  # Log terminal agent start
  echo "$(date -Iseconds),terminal-$SESSION_ID,terminal,main,0,$SESSION_ID,started" >> "$AGENT_STATS"
fi

exit 0
