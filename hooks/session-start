#!/usr/bin/env bash
# session-start: Track session and terminal agent start
set -euo pipefail

# Source shared library
source "${BASH_SOURCE[0]%/*}/lib/common.sh"

_warden_read_input || exit 0

SESSION_ID=$(_warden_parse_session_id)
SESSION_ID=$(_warden_sanitize_id "$SESSION_ID")
AGENT_STATS="$HOME/.claude/agent-stats.csv"

if [ -n "$SESSION_ID" ]; then
  mkdir -p "$HOME/.claude/.session-times"
  mkdir -p "$WARDEN_SESSION_BUDGET_DIR"
  date +%s > "$HOME/.claude/.session-times/$SESSION_ID.start"
  # Warden TUI: record session start for relative timestamps
  mkdir -p "$WARDEN_STATE_DIR"
  date +%s.%N > "$WARDEN_STATE_DIR/.session_start"

  # Snapshot budget at session start (if budget-cli is installed)
  if command -v budget-cli &>/dev/null; then
    budget-cli export > "$WARDEN_SESSION_BUDGET_DIR/$SESSION_ID.start.json" 2>/dev/null || true
    # BUG FIX #5: Refresh Prometheus textfile metrics with disown
    BUDGET_EXPORTER="$HOME/dev/claude-code-monitoring-guide/budget-exporter.sh"
    [[ -x "$BUDGET_EXPORTER" ]] && { "$BUDGET_EXPORTER" 2>/dev/null & disown; }
  fi

  # Initialize unified agent stats CSV with header if needed
  if [ ! -f "$AGENT_STATS" ]; then
    echo "timestamp,agent_id,agent_category,agent_type,duration_seconds,session_id,status" > "$AGENT_STATS"
  fi

  # Log terminal agent start
  echo "$(date -Iseconds),terminal-$SESSION_ID,terminal,main,0,$SESSION_ID,started" >> "$AGENT_STATS"
fi

exit 0
