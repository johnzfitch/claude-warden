#!/usr/bin/env bash
# session-end: Track terminal agent completion and session cleanup
set -euo pipefail

LOG_FILE="$HOME/.claude/session-log.txt"
STATUSLINE_STATE_DIR="$HOME/.claude/.statusline"
RESET_REASON_FILE="$STATUSLINE_STATE_DIR/reset-reason"
AGENT_STATS="$HOME/.claude/agent-stats.csv"
SESSION_BUDGET_DIR="$HOME/.claude/.session-budgets"
SESSION_COST_LOG="$HOME/.claude/.monitoring/session-costs.csv"

# Read input
INPUT=$(cat)

# Extract session info
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // "unknown"' 2>/dev/null || echo "unknown")
REASON=$(echo "$INPUT" | jq -r '.reason // ""' 2>/dev/null || echo "")

# Calculate terminal agent duration
SESSION_START_FILE="$HOME/.claude/.session-times/$SESSION_ID.start"
if [ -f "$SESSION_START_FILE" ]; then
  START_EPOCH=$(cat "$SESSION_START_FILE")
  END_EPOCH=$(date +%s)
  DURATION=$((END_EPOCH - START_EPOCH))
  DURATION_MIN=$((DURATION / 60))

  # Log terminal agent completion
  echo "$(date -Iseconds),terminal-$SESSION_ID,terminal,main,$DURATION,$SESSION_ID,completed" >> "$AGENT_STATS"

  # Track budget delta for this session (if budget-cli is installed)
  START_BUDGET_FILE="$SESSION_BUDGET_DIR/$SESSION_ID.start.json"
  if [ -f "$START_BUDGET_FILE" ] && command -v budget-cli &>/dev/null; then
    START_CONSUMED=$(jq -r '.consumed // 0' "$START_BUDGET_FILE" 2>/dev/null || echo 0)
    END_JSON=$(budget-cli export 2>/dev/null || echo '{"consumed":0}')
    END_CONSUMED=$(echo "$END_JSON" | jq -r '.consumed // 0')
    DELTA=$((END_CONSUMED - START_CONSUMED))

    # Initialize CSV if needed
    mkdir -p "$(dirname "$SESSION_COST_LOG")"
    if [ ! -f "$SESSION_COST_LOG" ]; then
      echo "timestamp,session_id,duration_seconds,budget_start,budget_end,budget_delta,subagent_count" > "$SESSION_COST_LOG"
    fi

    # Count subagents for this session
    SUBAGENT_COUNT=$(grep ",$SESSION_ID," "$AGENT_STATS" 2>/dev/null | grep ",subagent," | grep ",completed" | wc -l || echo 0)

    # Log session cost
    echo "$(date -Iseconds),$SESSION_ID,$DURATION,$START_CONSUMED,$END_CONSUMED,$DELTA,$SUBAGENT_COUNT" >> "$SESSION_COST_LOG"

    # Cleanup budget snapshot
    rm -f "$START_BUDGET_FILE"
  fi
else
  DURATION="unknown"
  DURATION_MIN="unknown"
fi

END_TIME=$(date '+%Y-%m-%d %H:%M:%S')

# Log session end
echo "[$END_TIME] Session ended: $SESSION_ID (duration: ${DURATION_MIN}m, dir: $PWD, reason: $REASON)" >> "$LOG_FILE"

# Record reset reason for statusline
if [ -n "$REASON" ]; then
    mkdir -p "$STATUSLINE_STATE_DIR"
    printf '%s|%s|%s\n' "$(date +%s)" "$REASON" "$SESSION_ID" > "$RESET_REASON_FILE"
fi

exit 0
