#!/usr/bin/env bash
# permission-request: Auto-deny dangerous commands, auto-allow safe ones
# Output JSON: "allow", "deny", or "ask" (default)
# NOTE: Commands in settings.json allow-list never reach this hook

set -euo pipefail

# Cross-platform timeout wrapper
_timeout() { command -v timeout &>/dev/null && timeout "$@" || command -v gtimeout &>/dev/null && gtimeout "$@" || { shift; "$@"; }; }

INPUT=$(_timeout 5 cat 2>/dev/null) || exit 0
[[ -z "$INPUT" ]] && exit 0

read -r TOOL_NAME COMMAND < <(
    printf '%s' "$INPUT" | jq -r '[.tool_name // "", .tool_input.command // ""] | @tsv' 2>/dev/null
) || exit 0

# Auto-deny dangerous patterns
# Normalize whitespace for matching (collapse runs, trim)
NORM_CMD=$(echo "$COMMAND" | tr -s '[:space:]' ' ')

case "$NORM_CMD" in
    # Destructive filesystem operations
    *"rm -rf /"*|*"rm -fr /"*|*"rm -rf ~"*|*"rm -fr ~"*|\
    *"rm -rf --no-preserve-root"*|\
    *"mkfs"*|*"dd if="*|\
    *"> /dev/sd"*|*"> /dev/nvme"*|\
    *"chmod -R 777 /"*|*"chown -R"*"/"*)
        echo '{"decision": "deny", "reason": "Blocked destructive command"}'
        exit 0 ;;
    # Fork bombs
    *':(){:|:&};:'*|*':(){ :|:&};:'*)
        echo '{"decision": "deny", "reason": "Blocked fork bomb"}'
        exit 0 ;;
    # Remote code execution via pipe
    *"curl"*"|"*"bash"*|*"curl"*"|"*"sh"*|\
    *"wget"*"|"*"bash"*|*"wget"*"|"*"sh"*|\
    *"bash <(curl"*|*"sh <(curl"*|\
    *"bash <(wget"*|*"sh <(wget"*)
        echo '{"decision": "deny", "reason": "Blocked remote code execution"}'
        exit 0 ;;
esac

# Auto-allow safe read-only commands not in settings.json allow-list
case "$COMMAND" in
    echo\ *|whoami|hostname|type\ *|man\ *|env|printenv|locale)
        echo '{"decision": "allow"}'
        exit 0 ;;
esac

# Default: ask user
echo '{"decision": "ask"}'
