#!/usr/bin/env bash
# stop: Handle stop events with duration tracking
set -euo pipefail

LOG_FILE="$HOME/.claude/session-log.txt"
read -r -t 5 -d '' INPUT || true
[[ -z "$INPUT" ]] && exit 0

IFS=$'\t' read -r REASON TOOL_NAME SESSION_ID < <(
    printf '%s' "$INPUT" | jq -r '[.reason // "unknown", .tool_name // "", .session_id // ""] | @tsv' 2>/dev/null
) || exit 0
# Sanitize: only safe characters (used in file paths)
[[ ! "$SESSION_ID" =~ ^[a-zA-Z0-9_-]+$ ]] && SESSION_ID=""

TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Calculate session duration
DURATION="unknown"
SESSION_TIME_FILE="$HOME/.claude/.session-times/$SESSION_ID.start"
if [ -n "$SESSION_ID" ] && [ -f "$SESSION_TIME_FILE" ]; then
  START_TIME=$(cat "$SESSION_TIME_FILE")
  END_TIME=$(date +%s)
  DURATION_SECS=$((END_TIME - START_TIME))
  DURATION="${DURATION_SECS}s"
fi

# Log stop event with duration
if [[ -n "$TOOL_NAME" ]]; then
  echo "[$TIMESTAMP] Stop: $REASON (tool: $TOOL_NAME, duration: $DURATION)" >> "$LOG_FILE"
else
  echo "[$TIMESTAMP] Stop: $REASON (duration: $DURATION)" >> "$LOG_FILE"
fi

exit 0
