#!/bin/bash
# tool-error: Error logging + notifications
# Runs on PostToolUseFailure
#
# All output goes to stderr or log files - NOT stdout
# (stdout could cause issues depending on how this event is processed)

set -euo pipefail

# Source shared library
source "${BASH_SOURCE[0]%/*}/lib/common.sh"

_warden_read_input || exit 0

TOOL_NAME=$(_warden_parse_tool_name)
ERROR_MSG=$(printf '%s' "$WARDEN_INPUT" | jq -r '.tool_error // .error // "unknown error"' 2>/dev/null)

# === ERROR LOGGING (to file) ===
ERROR_LOG="$HOME/.claude/errors.log"
{
  echo "=== Tool Error ==="
  echo "Time: $(date)"
  echo "Tool: $TOOL_NAME"
  echo "Error: $ERROR_MSG"
  echo "PWD: $PWD"
  echo "Git: $(git symbolic-ref --short HEAD 2>/dev/null || echo 'N/A')"
  echo ""
} >> "$ERROR_LOG"

# BUG FIX #4: Atomic log rotation (prevent race condition)
if [[ -f "$ERROR_LOG" ]] && [[ $(wc -l < "$ERROR_LOG" 2>/dev/null || echo 0) -gt 1500 ]]; then
  ERROR_LOG_TMP=$(mktemp "$ERROR_LOG.XXXXXX")
  tail -1000 "$ERROR_LOG" > "$ERROR_LOG_TMP" 2>/dev/null && mv "$ERROR_LOG_TMP" "$ERROR_LOG" 2>/dev/null || rm -f "$ERROR_LOG_TMP"
fi

# === HINTS TO STDERR (if we want Claude to see them) ===
case "$TOOL_NAME" in
  Bash)
    if echo "$ERROR_MSG" | grep -qi "permission denied"; then
      echo "Hint: May need sudo or file permissions check" >&2
    fi
    if echo "$ERROR_MSG" | grep -qi "command not found"; then
      echo "Hint: Check if command is installed or PATH is set" >&2
    fi
    ;;
  Edit|Write)
    if echo "$ERROR_MSG" | grep -qi "read-only"; then
      echo "Hint: File may be read-only or in a protected directory" >&2
    fi
    ;;
esac

exit 0
